name: Render charts & stats
on:
  workflow_dispatch:
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install libs
        run: |
          pip install pandas matplotlib numpy statsmodels scipy tabulate

      - name: Show repo tree (top)
        run: |
          echo "== top =="; ls -la
          echo "== 02-microsurvey-pulse =="; ls -la 02-microsurvey-pulse || true
          echo "== 02-microsurvey-pulse/data =="; ls -la 02-microsurvey-pulse/data || true
          echo "== docs =="; ls -la docs || true
          echo "== docs/02-microsurvey-pulse =="; ls -la docs/02-microsurvey-pulse || true
          echo "== docs/02-microsurvey-pulse/data =="; ls -la docs/02-microsurvey-pulse/data || true

      - name: Detect CSV path
        run: |
          set -e
          CANDIDATES=(
            "02-microsurvey-pulse/data/microsurvey_responses.csv"
            "docs/02-microsurvey-pulse/data/microsurvey_responses.csv"
            "docs/survey.csv"
            "docs/cleaned.csv"
          )
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              echo "Using CSV: $p"
              echo "SURVEY_CSV=$p" >> "$GITHUB_ENV"
              exit 0
            fi
          done
          echo "ERROR: No suitable CSV found"; exit 1

      - name: Run statistics
        run: |
          python 06-stats-and-modeling/src/run_stats.py
          echo "== wrote files =="; ls -la docs | grep -E 'desc_stats|corr_matrix|corr_heatmap|regression_results' || true

      - name: Commit updated outputs (manual)
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add docs/desc_stats.csv docs/corr_matrix.csv docs/corr_heatmap.png docs/regression_results.md || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Refresh statistical outputs"
            git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
            git push origin HEAD:main
          fi
