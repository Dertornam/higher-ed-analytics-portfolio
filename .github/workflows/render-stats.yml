name: Render charts & stats
on:
  workflow_dispatch:
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install libs
        run: |
          pip install pandas matplotlib numpy statsmodels scipy tabulate

      - name: Show repo tree (top)
        run: |
          echo "== top =="
          ls -la
          echo "== 02-microsurvey-pulse =="
          ls -la 02-microsurvey-pulse || true
          echo "== 02-microsurvey-pulse/data =="
          ls -la 02-microsurvey-pulse/data || true
          echo "== docs =="
          ls -la docs || true
          echo "== docs/02-microsurvey-pulse =="
          ls -la docs/02-microsurvey-pulse || true
          echo "== docs/02-microsurvey-pulse/data =="
          ls -la docs/02-microsurvey-pulse/data || true

      - name: Detect CSV path
        run: |
          set -e
          CANDIDATES=(
            "02-microsurvey-pulse/data/microsurvey_responses.csv"
            "docs/02-microsurvey-pulse/data/microsurvey_responses.csv"
            "docs/survey.csv"
            "docs/cleaned.csv"
          )
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              FOUND="$p"
              break
            fi
          done
          if [ -z "$FOUND" ]; then
            echo "ERROR: No suitable CSV found. Put a numeric survey CSV in one of:"
            printf '%s\n' "${CANDIDATES[@]}"
            exit 1
          fi
          echo "Using CSV: $FOUND"
          echo "SURVEY_CSV=$FOUND" >> $GITHUB_ENV

      - name: Run statistics
        run: |
          python 06-stats-and-modeling/src/run_stats.py
          echo "== wrote files =="
          ls -la docs | grep -E 'desc_stats|corr_matrix|corr_heatmap|regression_results' || true

      - name: Commit updated outputs
              - name: Commit updated outputs (manual)
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add docs/desc_stats.csv docs/corr_matrix.csv docs/corr_heatmap.png docs/regression_results.md
          git commit -m "Refresh statistical outputs" || echo "No changes to commit"

          # ensure the remote uses the token with write perms
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git push origin HEAD:main
        with:
          commit_message: "Refresh statistical outputs"
